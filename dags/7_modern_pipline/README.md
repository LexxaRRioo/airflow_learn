# 7_modern_pipline ‚Äî Airflow Datasets (—á–∏—Å—Ç—ã–π –ø–æ–¥—Ö–æ–¥)

–≠—Ç–∞ –ø–∞–ø–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å **Airflow Datasets** ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –º–µ—Ö–∞–Ω–∏–∑–º–æ–º —Å–≤—è–∑—ã–≤–∞–Ω–∏—è DAG'–æ–≤ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è –¥–∞–Ω–Ω—ã—Ö.

## –§–∏–ª–æ—Å–æ—Ñ–∏—è Dataset

**Dataset ‚Äî —ç—Ç–æ –Ω–µ –∫–∞–Ω–∞–ª –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö, –∞ –º–µ—Ö–∞–Ω–∏–∑–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏.**

- Producer –≥–æ–≤–æ—Ä–∏—Ç: "–Ø –ø–æ–ª–æ–∂–∏–ª –¥–∞–Ω–Ω—ã–µ –≤ —É—Å–ª–æ–≤–ª–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ".
- Consumer –∑–Ω–∞–µ—Ç —ç—Ç–æ –º–µ—Å—Ç–æ (–ø–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—é) –∏ —Å–∞–º –∏–¥—ë—Ç —Ç—É–¥–∞ –∑–∞ –¥–∞–Ω–Ω—ã–º–∏.
- Dataset URI ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ **–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –∏–º—è —Å–æ–±—ã—Ç–∏—è**, –∞ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É.

–í –Ω–∞—à–µ–º –ø—Ä–∏–º–µ—Ä–µ:
- URI Dataset: `minio://cats/raw`
- –°–æ–≥–ª–∞—à–µ–Ω–∏–µ: –¥–∞–Ω–Ω—ã–µ –ª–µ–∂–∞—Ç –≤ MinIO bucket `cats`, prefix `raw/`, –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ —Å–æ–¥–µ—Ä–∂–∞—Ç timestamp.
- Consumer –ø—Ä–æ—Å—Ç–æ –±–µ—Ä—ë—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–π–ª –ø–æ –∏–º–µ–Ω–∏ ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å "—Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ".

---

## –°–æ–¥–µ—Ä–∂–∏–º–æ–µ

- `7_1_cats_api_producer_dataset_dag.py` ‚Äî **Producer DAG** (—Å–æ–∑–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ)
- `7_2_cats_processor_dataset_dag.py` ‚Äî **Consumer DAG** (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ)

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. Producer DAG (`7_1_...`)

**–õ–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å TheCatAPI —á–µ—Ä–µ–∑ `HttpSensor`.
2. –ü–æ–ª—É—á–∞–µ—Ç N –∑–∞–ø–∏—Å–µ–π –æ –∫–æ—Ç–∞—Ö (metadata –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π).
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç raw JSON –≤ MinIO: `s3://cats/raw/cats_raw_20251223_150000.json`.
4. **–ü—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ Dataset** –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ `save_raw_to_minio`.

**–ö–ª—é—á–µ–≤–æ–π –∫–æ–¥:**
```python
CATS_RAW_DATASET = Dataset(f"minio://{RAW_BUCKET}/{RAW_PREFIX}")

@task(outlets=[CATS_RAW_DATASET])
def save_raw_to_minio(raw: Dict[str, Any]):
    # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–π–ª –≤ MinIO
    # –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–∏—á–µ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ ‚Äî Dataset —Å–æ–±—ã—Ç–∏–µ —Å–∞–º–æ –ø–æ —Å–µ–±–µ —è–≤–ª—è–µ—Ç—Å—è —Å–∏–≥–Ω–∞–ª–æ–º
    pass
```

–ö–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ, Airflow –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç **DatasetEvent**.

---

### 2. Consumer DAG (`7_2_...`)

**–õ–æ–≥–∏–∫–∞:**
1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è `CATS_RAW_DATASET`.
2. –ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–π–ª –≤ `s3://cats/raw/` (–ø–æ timestamp –≤ –∏–º–µ–Ω–∏).
3. –ß–∏—Ç–∞–µ—Ç JSON, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ Postgres.

**–ö–ª—é—á–µ–≤–æ–π –∫–æ–¥:**
```python
dag = DAG(
    dag_id="7_2_cats_processor_dataset_dag",
    schedule=[CATS_RAW_DATASET],  # <-- –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Dataset
    ...
)

@task
def read_latest_from_minio():
    s3 = S3Hook(...)
    keys = s3.list_keys(bucket_name="cats", prefix="raw/")
    latest_key = sorted(keys)[-1]  # –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ –∏–º–µ–Ω–∏
    return s3.read_key(key=latest_key, ...)
```

Consumer **–Ω–µ –ø—ã—Ç–∞–µ—Ç—Å—è –∏–∑–≤–ª–µ—á—å –ø—É—Ç—å –∏–∑ XCom –∏–ª–∏ —Å–æ–±—ã—Ç–∏—è** ‚Äî –æ–Ω –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞–µ—Ç —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ.

---

## –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥

### ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–∫–æ—Å—Ç—ã–ª–∏)
- –ü—ã—Ç–∞—Ç—å—Å—è –ø–µ—Ä–µ–¥–∞—Ç—å `bucket/key` —á–µ—Ä–µ–∑ XCom –∏–ª–∏ `DatasetEvent.extra`.
- –ü–∏—Å–∞—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ `triggering_dataset_events`.
- –î–µ–ª–∞—Ç—å fallback –Ω–∞ –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤, –µ—Å–ª–∏ XCom –Ω–µ –Ω–∞–π–¥–µ–Ω.

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ (–ø–æ –∑–∞–¥—É–º–∫–µ Airflow)
- Producer –∏ Consumer –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞—é—Ç—Å—è –æ **–º–µ—Å—Ç–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö** (bucket, prefix, —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –æ–± –∏–º–µ–Ω–∞—Ö).
- Dataset —Å–æ–±—ã—Ç–∏–µ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ **—Ç—Ä–∏–≥–≥–µ—Ä**: "–∏–¥–∏ –ø—Ä–æ–≤–µ—Ä—å, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ".
- Consumer —Å–∞–º –Ω–∞—Ö–æ–¥–∏—Ç –Ω—É–∂–Ω—ã–π —Ñ–∞–π–ª –ø–æ –∏–∑–≤–µ—Å—Ç–Ω–æ–º—É –µ–º—É –ø—Ä–∞–≤–∏–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ timestamp).

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥.
- –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏ Airflow (XCom, extra –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ-—Ä–∞–∑–Ω–æ–º—É).
- Consumer –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é ‚Äî –æ–Ω –ø—Ä–æ—Å—Ç–æ –≤–æ–∑—å–º—ë—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–π–ª).

---

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### 1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ

```bash
cd /home/envy/Lessons/airflow
./scripts/bootstrap_airflow.sh
```

–ù—É–∂–Ω—ã:
- Connection `thecatapi_default` (HTTP, host=`api.thecatapi.com`, schema=`https`)
- Connection `minio` (AWS S3, endpoint=`http://minio:9000`)
- Connection `postgres_data` (Postgres)
- Variables: `MINIO_BUCKET_CATS=cats`, `MINIO_RAW_PREFIX=raw`, etc.

### 2. –ó–∞–ø—É—Å—Ç–∏ Producer

–í Airflow UI:
- DAG: `7_1_cats_api_producer_dataset_dag`
- –ù–∞–∂–º–∏ **Trigger DAG** (–∫–Ω–æ–ø–∫–∞ play).

### 3. –ù–∞–±–ª—é–¥–∞–π Consumer

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è producer'–∞:
- `7_2_cats_processor_dataset_dag` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è (—á–µ—Ä–µ–∑ ~1-5 —Å–µ–∫).
- –í –ª–æ–≥–∞—Ö –ø–µ—Ä–≤–æ–π –∑–∞–¥–∞—á–∏ —É–≤–∏–¥–∏—à—å:
  ```
  üìÇ –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: 3
  ‚úÖ –í—ã–±—Ä–∞–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π: s3://cats/raw/cats_raw_20251223_150853.json
  ```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### MinIO UI
http://localhost:9001 (login: `minioadmin` / `minioadmin`)

Bucket `cats`, prefix `raw/` –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ñ–∞–π–ª—ã:
```
raw/cats_raw_20251223_150000.json
raw/cats_raw_20251223_151230.json
...
```

### Postgres
```sql
SELECT * FROM cat_images ORDER BY created_at DESC LIMIT 10;
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏ —Å –ø–æ–ª—è–º–∏: `id`, `url`, `width`, `height`, `load_dt`.

---

## –û—Ç–ª–∏—á–∏—è –æ—Ç legacy –ø–æ–¥—Ö–æ–¥–∞ (TriggerDagRunOperator)

| **Legacy (6_legacy_pipline)** | **Modern (7_modern_pipline)** |
|-------------------------------|-------------------------------|
| Producer —è–≤–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç consumer —á–µ—Ä–µ–∑ `TriggerDagRunOperator` | Consumer –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ Dataset –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `conf` (jinja) | –î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –º–µ—Å—Ç–∞ (—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ) |
| –ñ—ë—Å—Ç–∫–∞—è —Å–≤—è–∑—å: `trigger_dag_id="consumer_dag"` | –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–≤—è–∑—å: `schedule=[DATASET]` |
| +1 –∑–∞–¥–∞—á–∞ –≤ producer –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ | –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á |
| Consumer –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `conf` | Consumer –Ω–µ–∑–∞–≤–∏—Å–∏–º (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é) |

---

## Dataset –≤ Airflow UI

### –ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å

1. **Datasets** (–≤ –≤–µ—Ä—Ö–Ω–µ–º –º–µ–Ω—é):
   - –£–≤–∏–¥–∏—à—å `minio://cats/raw`.
   - –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π (–∫–æ–≥–¥–∞ producer –ø—É–±–ª–∏–∫–æ–≤–∞–ª –¥–∞–Ω–Ω—ã–µ).
   - –°–≤—è–∑–∞–Ω–Ω—ã–µ DAG'–∏ (producer –∏ consumer).

2. **DAG Graph (7_2_...):**
   - –ù–∞–¥ –≥—Ä–∞—Ñ–æ–º –±—É–¥–µ—Ç –ø–ª–∞—à–∫–∞: "Triggered by Dataset: minio://cats/raw".

3. **DAG Run Details:**
   - –í –¥–µ—Ç–∞–ª—è—Ö run'–∞ consumer'–∞ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å `triggering_dataset_events`.

---

## –î–µ–±–∞–≥

### Consumer –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ producer –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ (–∑–∞–¥–∞—á–∞ `save_raw_to_minio` ‚Äî **SUCCESS**).
2. –ü–µ—Ä–µ–π–¥–∏ –≤ **Datasets** ‚Üí `minio://cats/raw` ‚Äî —Ç–∞–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–±—ã—Ç–∏–µ.
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ consumer DAG –≤–∫–ª—é—á—ë–Ω (toggle ON –≤ —Å–ø–∏—Å–∫–µ DAG'–æ–≤).

### –û—à–∏–±–∫–∞ "–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –≤ s3://cats/raw"

Producer –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–ª —Ñ–∞–π–ª—ã –∏–ª–∏ MinIO –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

```bash
docker compose ps | grep minio
```

–ü–æ–ø—Ä–æ–±—É–π –≤—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å—Ç–∏—Ç—å producer.

### Consumer –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. Consumer –±–µ—Ä—ë—Ç **–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ –∏–º–µ–Ω–∏** —Ñ–∞–π–ª –∏–∑ prefix. –ï—Å–ª–∏ producer —Å–æ–∑–¥–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –ø–æ–¥—Ä—è–¥, consumer –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π.

---

## –°–º. —Ç–∞–∫–∂–µ

- [Airflow Datasets ‚Äî –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://airflow.apache.org/docs/apache-airflow/stable/authoring-and-scheduling/datasets.html)
- –ü–∞–ø–∫–∞ `6_legacy_pipline` ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —á–µ—Ä–µ–∑ `TriggerDagRunOperator`.
- –ü–∞–ø–∫–∞ `5_basic_pipeline` ‚Äî –ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å Sensors –∏ –ø—Ä–æ—Å—Ç—ã–º–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏.


