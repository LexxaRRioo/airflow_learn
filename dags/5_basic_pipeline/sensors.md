## Сенсоры (Sensors)

Сенсоры — это особый тип операторов, предназначенный для выполнения ровно одной задачи — **ожидания наступления какого-либо события**. Это может быть ожидание по времени, ожидание появления файла или ожидание внешнего события, но в любом случае сенсор просто ждёт, пока что-то произойдёт, после чего успешно завершается, позволяя запуститься последующим задачам (downstream tasks).

Поскольку сенсоры в основном находятся в состоянии ожидания, они могут работать в **двух режимах**, что позволяет более эффективно использовать ресурсы:

* **poke (по умолчанию)**: сенсор занимает слот воркера на всё время своего выполнения.
* **reschedule**: сенсор занимает слот воркера только в момент проверки условия, а между проверками «засыпает» на заданный интервал времени.

Режимы **poke** и **reschedule** можно настроить напрямую при создании сенсора. Как правило, выбор между ними — это компромисс между потреблением ресурсов и задержкой (latency). Например, если проверка выполняется каждую секунду, целесообразно использовать режим **poke**; если проверка происходит раз в минуту, лучше использовать режим **reschedule**.

Так же, как и в случае с операторами, Airflow предоставляет большое количество готовых сенсоров — как встроенных в ядро Airflow, так и доступных через систему провайдеров.

---

## Что нужно сенсорам для работы

### 1) Worker/Executor
Сенсор — это задача, она **выполняется воркером** (или самим scheduler’ом при LocalExecutor). Поэтому важно помнить:

- в режиме **poke** сенсор держит executor slot всё время ожидания;
- в режиме **reschedule** он отпускает слот и «возвращается» через интервал.

Если у тебя мало слотов/воркеров, `poke` может легко «забить» очередь.

### 2) Connections (очень важно)
Многие сенсоры работают **через Airflow Connection**:

- `HttpSensor` использует `http_conn_id` (типа `http`).
- `FileSensor` использует `fs_conn_id` (типа `fs`).

Практика:
- в Connection хранится **base host/path**, а в DAG передаётся **только endpoint/relative filepath**.

Типовая ошибка:
- передать **полный URL** в `endpoint` и получить кривую склейку `host + full_url` → 404/invalid URL.

---

## Ключевые параметры сенсоров

### Общие (почти у всех сенсоров)
- `poke_interval`: как часто проверять условие (сек).
- `timeout`: сколько максимум ждать до падения сенсора.
- `mode`: `poke` или `reschedule`.
- `soft_fail=True`: вместо FAILED → SKIPPED (полезно для необязательных ожиданий).

### HttpSensor
- `http_conn_id`: conn типа `http`.
- `endpoint`: **только path**, например `/v1/images/search`.
- `request_params`: query params (`{"limit": 1}` и т.п.).
- `headers`: заголовки.
- `response_check`: функция проверки ответа (например, `lambda r: r.status_code == 200`).

### FileSensor
Импорт (core):

- `from airflow.sensors.filesystem import FileSensor`

Параметры:
- `fs_conn_id`: обычно `fs_default`.
- `filepath`: путь **относительно base path** из fs-connection или абсолютный (зависит от conn.extra.path).

---

## Пара слов про UI: чем отличается poke vs reschedule

- **poke**: задача видна как RUNNING почти постоянно (занимает слот).
- **reschedule**: между проверками задача будет в состоянии `UP_FOR_RESCHEDULE` (слот освобождается), и в UI кажется «менее активной».

---

[источник](https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/sensors.html)
